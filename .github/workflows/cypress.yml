name: Cypress Tests for Helpdesk API

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:    # Executa diariamente Ã s 2:00 AM UTC
    - cron: "0 2 * * *"

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Instalar dependÃªncias
        run: npm ci

      - name: Setup Helpdesk API
        if: success() && !cancelled()
        run: |
          # Tenta clonar a API Helpdesk
          if git clone https://github.com/automacaohml/helpdesk-api.git api; then
            echo "âœ… RepositÃ³rio da API clonado com sucesso"
            cd api
            
            # Instala dependÃªncias da API
            npm install
            
            # Inicia a API em background
            nohup npm start > ../api.log 2>&1 &
            echo "âœ… API iniciada em background"
            
            # Aguarda um momento para a API inicializar
            sleep 5
            
          else
            echo "âš ï¸ NÃ£o foi possÃ­vel clonar a API, assumindo API jÃ¡ rodando"
          fi

      - name: Aguardar API estar disponÃ­vel
        run: |
          echo "ðŸ”„ Aguardando API ficar disponÃ­vel..."
          
          # Aguarda atÃ© 60 segundos pela API
          for i in {1..30}; do
            if curl -s http://localhost:3000/ > /dev/null 2>&1 || 
               curl -s http://localhost:3000/health > /dev/null 2>&1 || 
               curl -s http://localhost:3000/users > /dev/null 2>&1; then
              echo "âœ… API disponÃ­vel na porta 3000"
              break
            fi
            echo "Tentativa $i/30 - Aguardando API..."
            sleep 2
          done
          
          # Verifica se API estÃ¡ realmente funcionando
          echo "Testando endpoints da API..."
          if curl -f http://localhost:3000/health > /dev/null 2>&1; then
            echo "âœ… Health endpoint OK"
          elif curl -f http://localhost:3000/ > /dev/null 2>&1; then
            echo "âœ… Root endpoint OK" 
          elif curl -f http://localhost:3000/users > /dev/null 2>&1; then
            echo "âœ… Users endpoint OK"
          else
            echo "âŒ Erro: Nenhum endpoint da API estÃ¡ respondendo"
            cat api.log
            exit 1
          fi

      - name: Debug - Verificar status da API
        if: always() && !cancelled()
        run: |
          echo "=== Status da API ==="
          curl -s http://localhost:3000/health || echo "Health endpoint nÃ£o disponÃ­vel"
          curl -s http://localhost:3000/users || echo "Users endpoint nÃ£o disponÃ­vel"
          ps aux | grep node || echo "Nenhum processo Node encontrado"

      - name: Executar testes Cypress
        if: always() && !cancelled()
        continue-on-error: true
        run: |
          echo "ðŸš€ Iniciando testes de API com Cypress"
          
          # Cria diretÃ³rios necessÃ¡rios
          mkdir -p cypress/reports
          
          # Executa Cypress para testes de API (headless por padrÃ£o)
          npx cypress run \
            --reporter mochawesome \
            --reporter-options "reportDir=cypress/reports,reportFilename=mochawesome-api,overwrite=false,html=false,json=true" \
            --config "video=false,screenshotOnRunFailure=false,defaultCommandTimeout=10000,requestTimeout=15000" \
            || {
              echo "âš ï¸ Cypress falhou, mas continuando para gerar artifacts..."
              # Cria um relatÃ³rio bÃ¡sico para evitar falhas downstream
              echo '{"stats":{"suites":1,"tests":1,"passes":0,"pending":0,"failures":1,"start":"2024-01-01T00:00:00.000Z","end":"2024-01-01T00:01:00.000Z","duration":60000,"testsRegistered":1,"passPercent":0,"pendingPercent":0,"other":0,"hasOther":false,"skipped":0,"hasSkipped":false},"results":[{"title":"Cypress API Tests Failed","fullTitle":"API execution failed with exit code","state":"failed","err":{"message":"Cypress API tests failed"}}],"meta":{"mocha":{"version":"7.0.0"},"mochawesome":{"version":"7.0.0","options":{}},"marge":{"options":{},"version":"6.2.0"}}}' > cypress/reports/mochawesome-api.json
            }
        env:
          CYPRESS_baseUrl: http://localhost:3000
          CYPRESS_apiUrl: http://localhost:3000

      - name: Gerar relatÃ³rios
        if: always() && !cancelled()
        continue-on-error: true
        run: |
          # Cria diretÃ³rio de reports se nÃ£o existir
          mkdir -p cypress/reports/html
          
          # Lista arquivos encontrados para debug
          echo "=== Arquivos no diretÃ³rio cypress/reports ==="
          ls -la cypress/reports/ 2>/dev/null || echo "DiretÃ³rio cypress/reports nÃ£o existe"
          
          echo "=== Procurando arquivos mochawesome ==="
          find cypress/reports -name "mochawesome*" -type f 2>/dev/null || echo "Nenhum arquivo mochawesome encontrado"
          
          # Verifica se existem arquivos JSON do mochawesome para merge
          if ls cypress/reports/mochawesome*.json >/dev/null 2>&1; then
            echo "âœ… Arquivos Mochawesome JSON encontrados:"
            ls cypress/reports/mochawesome*.json
            
            echo "Fazendo merge dos relatÃ³rios..."
            npx mochawesome-merge "cypress/reports/mochawesome*.json" > cypress/reports/merged-report.json || {
              echo "âš ï¸ Erro no merge, criando relatÃ³rio vazio completo"
              echo '{"stats":{"suites":0,"tests":0,"passes":0,"pending":0,"failures":0,"start":"2024-01-01T00:00:00.000Z","end":"2024-01-01T00:01:00.000Z","duration":0,"testsRegistered":0,"passPercent":0,"pendingPercent":0,"other":0,"hasOther":false,"skipped":0,"hasSkipped":false},"results":[],"meta":{"mocha":{"version":"10.0.0"},"mochawesome":{"version":"7.1.3","options":{"reportDir":"cypress/reports","reportTitle":"Cypress Tests"}},"marge":{"options":{"reportDir":"cypress/reports/html"},"version":"6.2.0"}}}' > cypress/reports/merged-report.json
            }
            
            echo "Gerando relatÃ³rio HTML..."
            npx marge cypress/reports/merged-report.json --reportDir cypress/reports/html --reportTitle "Cypress Tests" || echo "âš ï¸ Erro na geraÃ§Ã£o do relatÃ³rio HTML"
          else
            echo "âš ï¸ Nenhum arquivo Mochawesome JSON encontrado, criando relatÃ³rio vazio completo"
            echo '{"stats":{"suites":0,"tests":0,"passes":0,"pending":0,"failures":0,"start":"2024-01-01T00:00:00.000Z","end":"2024-01-01T00:01:00.000Z","duration":0,"testsRegistered":0,"passPercent":0,"pendingPercent":0,"other":0,"hasOther":false,"skipped":0,"hasSkipped":false},"results":[],"meta":{"mocha":{"version":"10.0.0"},"mochawesome":{"version":"7.1.3","options":{"reportDir":"cypress/reports","reportTitle":"Cypress Tests"}},"marge":{"options":{"reportDir":"cypress/reports/html"},"version":"6.2.0"}}}' > cypress/reports/merged-report.json
            npx marge cypress/reports/merged-report.json --reportDir cypress/reports/html --reportTitle "Cypress Tests" || echo "âš ï¸ Erro na geraÃ§Ã£o do relatÃ³rio HTML"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always() && !cancelled()
        with:
          name: cypress-results
          path: |
            cypress/reports/
          retention-days: 7

      - name: Resumo da execuÃ§Ã£o
        if: always() && !cancelled()
        run: |
          echo "=== RESUMO DA EXECUÃ‡ÃƒO ==="
          echo "Tipo: Testes de API REST"
          echo "API Status: $(curl -s http://localhost:3000/ > /dev/null 2>&1 && echo "âœ… Online" || echo "âŒ Offline")"
          echo "RelatÃ³rios JSON: $(find cypress/reports -name "*.json" 2>/dev/null | wc -l || echo "0")"
          if [ -f api.log ]; then
            echo "Logs da API: âœ… DisponÃ­veis"
          else
            echo "Logs da API: âŒ NÃ£o encontrados"
          fi
          
          # DetecÃ§Ã£o dinÃ¢mica de categorias de testes
          echo ""
          echo "ðŸ“Š Estrutura de testes detectada:"
          TOTAL_FILES=$(find cypress/e2e -name "*.cy.js" 2>/dev/null | wc -l || echo "0")
          echo "   ðŸ“ Total: $TOTAL_FILES arquivos de teste"
          
          # Scan automÃ¡tico de diretÃ³rios de teste
          for dir in cypress/e2e/api/*/; do
            if [ -d "$dir" ]; then
              category=$(basename "$dir")
              count=$(find "$dir" -name "*.cy.js" 2>/dev/null | wc -l || echo "0")
              case "$category" in
                "users") echo "   ðŸ‘¥ Users: $count arquivos" ;;
                "tickets") echo "   ðŸŽ« Tickets: $count arquivos" ;;
                "schemas") echo "   ðŸ“‹ Schemas: $count arquivos" ;;
                "integration") echo "   ðŸ”„ Integration: $count arquivos" ;;
                "negative") echo "   âŒ Negative: $count arquivos" ;;
                *) echo "   ðŸ“‚ $category: $count arquivos" ;;
              esac
            fi
          done
          
          # Arquivos na raiz da API
          ROOT_FILES=$(find cypress/e2e/api -maxdepth 1 -name "*.cy.js" 2>/dev/null | wc -l || echo "0")
          if [ "$ROOT_FILES" -gt 0 ]; then
            echo "   âš™ï¸ Config/Root: $ROOT_FILES arquivos"
          fi
          
          echo ""
          echo "âœ… ExecuÃ§Ã£o dos testes Cypress completada"
          echo "ðŸ“¦ Artifacts disponÃ­veis na aba Actions deste repositÃ³rio"

      - name: Gerar SumÃ¡rio no GitHub
        if: always() && !cancelled()
        run: |
          # Extrai estatÃ­sticas dos relatÃ³rios JSON do Cypress
          TOTAL_TESTS=0
          PASSED_TESTS=0
          FAILED_TESTS=0
          SKIPPED_TESTS=0
          
          # Processa todos os arquivos de relatÃ³rio JSON
          if ls cypress/reports/mochawesome*.json >/dev/null 2>&1; then
            for report in cypress/reports/mochawesome*.json; do
              if [ -f "$report" ]; then
                # Extrai estatÃ­sticas usando jq ou python
                if command -v jq >/dev/null 2>&1; then
                  TESTS=$(jq -r '.stats.tests // 0' "$report")
                  PASSES=$(jq -r '.stats.passes // 0' "$report")
                  FAILURES=$(jq -r '.stats.failures // 0' "$report")
                  PENDING=$(jq -r '.stats.pending // 0' "$report")
                else
                  # Fallback usando grep e sed
                  TESTS=$(grep -o '"tests":[0-9]*' "$report" | head -1 | sed 's/"tests"://' || echo "0")
                  PASSES=$(grep -o '"passes":[0-9]*' "$report" | head -1 | sed 's/"passes"://' || echo "0")
                  FAILURES=$(grep -o '"failures":[0-9]*' "$report" | head -1 | sed 's/"failures"://' || echo "0")
                  PENDING=$(grep -o '"pending":[0-9]*' "$report" | head -1 | sed 's/"pending"://' || echo "0")
                fi
                
                TOTAL_TESTS=$((TOTAL_TESTS + TESTS))
                PASSED_TESTS=$((PASSED_TESTS + PASSES))
                FAILED_TESTS=$((FAILED_TESTS + FAILURES))
                SKIPPED_TESTS=$((SKIPPED_TESTS + PENDING))
              fi
            done
          fi
          
          # Calcula porcentagens
          if [ "$TOTAL_TESTS" -gt 0 ]; then
            PASS_RATE=$((PASSED_TESTS * 100 / TOTAL_TESTS))
            FAIL_RATE=$((FAILED_TESTS * 100 / TOTAL_TESTS))
          else
            PASS_RATE=0
            FAIL_RATE=0
          fi
          
          # Determina status geral
          if [ "$FAILED_TESTS" -eq 0 ] && [ "$TOTAL_TESTS" -gt 0 ]; then
            STATUS="âœ… SUCESSO"
            STATUS_EMOJI="ðŸŽ‰"
          elif [ "$FAILED_TESTS" -gt 0 ]; then
            STATUS="âŒ FALHAS DETECTADAS"
            STATUS_EMOJI="ðŸ”¥"
          else
            STATUS="âš ï¸ NENHUM TESTE EXECUTADO"
            STATUS_EMOJI="â“"
          fi
          
          # Conta arquivos e estrutura
          TOTAL_FILES=$(find cypress/e2e -name "*.cy.js" 2>/dev/null | wc -l || echo "0")
          
          # Gera o GitHub Summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ${STATUS_EMOJI} RelatÃ³rio de Testes Cypress - Helpdesk API
          
          ## ðŸ“Š EstatÃ­sticas Gerais
          
          | MÃ©trica | Valor | Porcentagem |
          |---------|-------|-------------|
          | **Status Geral** | **${STATUS}** | - |
          | **Total de Testes** | **${TOTAL_TESTS}** | 100% |
          | **âœ… Aprovados** | ${PASSED_TESTS} | ${PASS_RATE}% |
          | **âŒ Falharam** | ${FAILED_TESTS} | ${FAIL_RATE}% |
          | **â­ï¸ Skip's** | ${SKIPPED_TESTS} | - |
          
          ## ðŸ“ Estrutura de Testes
          
          | Categoria | Arquivos | DescriÃ§Ã£o |
          |-----------|----------|-----------|
          EOF
          
          # Adiciona estrutura dinÃ¢mica ao summary
          for dir in cypress/e2e/api/*/; do
            if [ -d "$dir" ]; then
              category=$(basename "$dir")
              count=$(find "$dir" -name "*.cy.js" 2>/dev/null | wc -l || echo "0")
              case "$category" in
                "users") 
                  echo "| ðŸ‘¥ Users | ${count} | Testes de usuÃ¡rios e autenticaÃ§Ã£o |" >> $GITHUB_STEP_SUMMARY
                  ;;
                "tickets") 
                  echo "| ðŸŽ« Tickets | ${count} | Testes de tickets e workflow |" >> $GITHUB_STEP_SUMMARY
                  ;;
                "schemas") 
                  echo "| ðŸ“‹ Schemas | ${count} | ValidaÃ§Ã£o de contratos da API |" >> $GITHUB_STEP_SUMMARY
                  ;;
                "integration") 
                  echo "| ðŸ”„ Integration | ${count} | Testes de integraÃ§Ã£o completa |" >> $GITHUB_STEP_SUMMARY
                  ;;
                "negative") 
                  echo "| âŒ Negative | ${count} | Testes de casos de erro |" >> $GITHUB_STEP_SUMMARY
                  ;;
                *) 
                  echo "| ðŸ“‚ ${category} | ${count} | Testes de ${category} |" >> $GITHUB_STEP_SUMMARY
                  ;;
              esac
            fi
          done
          
          # Adiciona arquivos na raiz se existirem
          ROOT_FILES=$(find cypress/e2e/api -maxdepth 1 -name "*.cy.js" 2>/dev/null | wc -l || echo "0")
          if [ "$ROOT_FILES" -gt 0 ]; then
            echo "| âš™ï¸ Config/Root | ${ROOT_FILES} | Testes de configuraÃ§Ã£o |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Adiciona seÃ§Ã£o de artifacts
          cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ## ðŸ“¦ Artifacts Gerados
          
          | Tipo | Quantidade | LocalizaÃ§Ã£o |
          |------|------------|-------------|
          | ðŸ“‹ RelatÃ³rios HTML | 1 | \`cypress/reports/html/\` |
          | ï¿½ RelatÃ³rios JSON | 1+ | \`cypress/reports/\` |
          
          ## ðŸ” Como Visualizar os Resultados
          
          1. **ðŸ“¦ Download dos Artifacts**: Clique em "cypress-results" na seÃ§Ã£o Artifacts desta execuÃ§Ã£o
          2. **ðŸ“‹ RelatÃ³rio HTML**: Abra o arquivo \`merged-report.html\` no seu navegador
          3. **ðŸ“Š Dados JSON**: Analise os dados detalhados nos arquivos JSON
          
          ---
          
          **ðŸ¤– Gerado automaticamente pelo workflow de CI/CD** | **â° $(date '+%d/%m/%Y Ã s %H:%M:%S')**
          EOF
